#cloud-config
package_update: true
package_upgrade: true

hostname: ${hostname}
manage_etc_hosts: true

packages:
  - curl
  - jq
  - htop
  - iotop
  - sysstat
  - lsof

write_files:
  - path: /provision/refplat
    owner: root:root
    permissions: "0644"
    content: '${jsonencode(cfg.refplat)}'
  - path: /provision/cml.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, cml)}
  - path: /provision/common.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, common)}
  - path: /provision/copyfile.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, copyfile)}
  - path: /provision/vars.sh
    owner: root:root
    permissions: "0600"
    content: |
      ${indent(6, format("%s\n%s", vars, extras))}
  - path: /provision/del.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, del)}
  - path: /provision/interface_fix.py
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, interface_fix)}
  - path: /provision/license.py
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, license)}
  - path: /provision/cml_install_fix.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, file("${path}/../data/cml_install_fix.sh"))}
  - path: /provision/cml_install_reliable.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, reliable_install)}
  - path: /etc/virl2-base-config.yml
    owner: root:root
    permissions: "0644"
    content: |
      ${indent(6, format("%s\n", cml_config))}
  %{ for script in cfg.app.customize }
  - path: /provision/${script}
    owner: root:root
    permissions: "0644"
    content: |
      ${indent(6, file("${path}/../data/${script}"))}
  %{ endfor }

runcmd:
  - echo "========== STARTING CML INSTALLATION $(date) ==========" > /var/log/cml-provision.log
  - echo "Setting up logging redirection to capture all installation steps"
  - exec > >(tee -a /var/log/cml-provision.log) 2>&1
  - echo "Cloud-init runcmd starting at $(date)"
  - echo "Removing previous service file if it exists"
  - rm -f /etc/systemd/system/cml_install.service
  - systemctl daemon-reload
  - echo "Setting up reliable installation script at $(date)"
  - cp /provision/cml_install_reliable.sh /var/lib/cloud/instance/scripts/
  - chmod +x /var/lib/cloud/instance/scripts/cml_install_reliable.sh
  - mkdir -p /var/log/cml
  - echo "Starting CML installation with reliable script at $(date)"
  - bash /var/lib/cloud/instance/scripts/cml_install_reliable.sh > >(tee -a /var/log/cml_reliable_install.log) 2>&1 || echo "Reliable script failed, attempting fallback at $(date)" > >(tee -a /var/log/cml-provision.log) 2>&1 
  - if [ $? -ne 0 ]; then
  -   echo "Attempting fallback installation with fix script at $(date)" > >(tee -a /var/log/cml-provision.log) 2>&1
  -   bash /provision/cml_install_fix.sh > >(tee -a /var/log/cml_fix_install.log) 2>&1
  - fi
  - echo "Installation process completed at $(date)" > >(tee -a /var/log/cml-provision.log) 2>&1
  - touch /run/reboot
  - echo "========== CML INSTALLATION FINISHED $(date) ==========" > >(tee -a /var/log/cml-provision.log) 2>&1
  - echo "System will now reboot"

power_state:
  mode: reboot
  condition: test -f /run/reboot
  delay: "now"
  timeout: 300
  message: "Rebooting after CML installation"
