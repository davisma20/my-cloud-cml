#cloud-config
# package_update: true
# package_upgrade: true

hostname: ${hostname}
manage_etc_hosts: true

packages:
  - curl
  - jq
  - htop
  - iotop
  - sysstat
  - lsof

write_files:
  - path: /provision/refplat
    owner: root:root
    permissions: "0644"
    content: '${jsonencode(cfg.refplat)}'
  - path: /provision/cml.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, cml)}
  - path: /provision/common.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, common)}
  - path: /provision/copyfile.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, copyfile)}
  - path: /provision/vars.sh
    owner: root:root
    permissions: "0600"
    content: |
      ${indent(6, format("%s\n%s", vars, extras))}
  - path: /provision/del.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, del)}
  - path: /provision/interface_fix.py
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, interface_fix)}
  - path: /provision/license.py
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, license)}
  - path: /provision/cml_install_fix.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, file("${path}/../data/cml_install_fix.sh"))}
  - path: /provision/cml_install_reliable.sh
    owner: root:root
    permissions: "0700"
    content: |
      ${indent(6, reliable_install)}
  - path: /etc/virl2-base-config.yml
    owner: root:root
    permissions: "0644"
    content: |
      ${indent(6, format("%s\n", cml_config))}
  %{ for script in cfg.app.customize }
  - path: /provision/${script}
    owner: root:root
    permissions: "0644"
    content: |
      ${indent(6, file("${path}/../data/${script}"))}
  %{ endfor }

runcmd:
  # Redirect stdout and stderr for the *entire* runcmd block to the log file
  - exec >> /var/log/cml-provision.log 2>&1
  - echo "========== STARTING MINIMAL CLOUD-INIT $(date) =========="
  
  # Minimal steps needed after Packer build (if any)
  # Example: Maybe ensure hostname is set correctly if Packer didn't?
  # (Currently hostname is set earlier in cloud-config)

  # Removed hibinit-agent diagnostics
  # Removed CML installation script execution (cml_install_reliable.sh, cml_install_fix.sh)
  # Removed touch /run/reboot
  
  - echo "========== MINIMAL CLOUD-INIT FINISHED $(date) =========="
